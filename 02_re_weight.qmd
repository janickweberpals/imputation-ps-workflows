---
title: "Including sampling weights"
author: Janick Weberpals, RPh, PhD
date: last-modified
format: html
code-fold: false
toc: true
toc-depth: 3
code-tools: true
editor: visual
---

This is a reproducible example on how to incorporate sampling weights in multiple imputation \> matching/weighting \> balance assessment \> outcome analysis workflows.

Load packages:

```{r}
#| label: setup
#| message: false

library(here)
library(dplyr)
library(survival)
library(mice)
library(MatchThem)
library(survey)
library(anesrake)

source(here("functions", "source_encore.io_functions.R"))
```

## Data generation

We use again the `simulate_flaura()` function to simulate a realistic oncology comparative effectiveness cohort analytic dataset.

```{r}
#| label: data_generation
#| warning: false

# load example dataset with missing observations
data_miss <- simulate_flaura(
  n_total = 3500, 
  treat_prevalence = .51, 
  seed = 41, 
  include_id = FALSE, 
  imposeNA = TRUE
  )

covariates <- data_miss |> 
  select(starts_with("c_"), starts_with("dem_")) |> 
  colnames()
```

## Multiple imputation

Multiple imputation using `mice:`

```{r}
#| label: mice

# impute data
data_imp <- futuremice(
  parallelseed = 42,
  n.core = 7,
  data = data_miss,
  method = "rf",
  m = 10,
  print = FALSE
  )
```

## Propensity score matching and weighting

Apply propensity score matching and weighting with replacement within in each imputed dataset:

```{r}
#| label: matching-weighting
#| warning: false

# apply propensity score matching on mids object
ps_form <- as.formula(paste("treat ~", paste(covariates, collapse = " + ")))

# call match re-weight
test <- lapply(
  X = 1:data_imp$m, 
  FUN = match_re_weight,
  i = 1,
  mids_object = data_imp,
  ps_formula = ps_form,
  ratio = 1,
  method = "nearest",
  distance = "glm",
  link = "logit",
  caliper = 0.01,
  replace = F
  )

# matching
data_mimids <- matchthem(
  formula = ps_form,
  datasets = data_imp,
  approach = 'within',
  method = 'nearest',
  caliper = 0.01,
  ratio = 1,
  replace = F
  )
```

## Define and estimate sampling weights

```{r}

```
