[
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Multiple imputation-propensity score workflows",
    "section": "",
    "text": "Background\nMultiple imputation is a powerful tool in presence of missing data. However, especially in combination with propensity score analyses, multiple imputation can lead to challenges since analytic workflows can be become much more complex.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>README</span>"
    ]
  },
  {
    "objectID": "index.html#objective",
    "href": "index.html#objective",
    "title": "Multiple imputation-propensity score workflows",
    "section": "Objective",
    "text": "Objective\nThis repository showcases and evaluation different multiple imputation &gt; propensity score &gt; outcome analyses and associated implementation challenges.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>README</span>"
    ]
  },
  {
    "objectID": "index.html#sec-dependencies",
    "href": "index.html#sec-dependencies",
    "title": "Multiple imputation-propensity score workflows",
    "section": "Dependencies",
    "text": "Dependencies\nThis is a quarto book project and R package dependencies are managed through the renv package. All packages and their versions can be viewed in the lockfile renv.lock. All required packages and the appropriate versions can be installed by running the following command:\n\nrenv::restore(repos = \"https://packagemanager.posit.co/cran/latest\")\n\n\n\n\n\n\n\nImportant\n\n\n\nThe dependencies are managed through Posit’s repository package manager (RSPM). If you use a different operating system than macOS, please head over to the RSPM setup website and follow these steps to adjust the URL above.\n\nGo to the RSPM setup website\nChoose the operating system (if Linux, also choose the Linux distribution)\nGo to Repository URL: and copy-paste the URL to the options statement in the .Rprofile file\noptions(repos = c(REPO_NAME = “URL”))",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>README</span>"
    ]
  },
  {
    "objectID": "index.html#reproducibility",
    "href": "index.html#reproducibility",
    "title": "Multiple imputation-propensity score workflows",
    "section": "Reproducibility",
    "text": "Reproducibility\nFollow these steps in RStudio to reproduce this study:\n\n\n\n\n\n\nNote\n\n\n\n\nClone this repository via git clone &lt;url&gt; or in RStudio via File &gt; New Project &gt; Version Control &gt; Git &gt; then paste the link to repository URL\nInstall all necessary dependencies (see above)\nAdd/adapt the paths to the datasets in .Renviron\nIn RStudio, run all scripts via quarto render or Build &gt; Render Book (make sure quarto is installed)\n\n\n\n\nSteps to clone this repository in RStudio\n\n\n\n\nThe data used in this project is strictly simulated and no real patient-level data is used.",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>README</span>"
    ]
  },
  {
    "objectID": "index.html#repository-structure-and-files",
    "href": "index.html#repository-structure-and-files",
    "title": "Multiple imputation-propensity score workflows",
    "section": "Repository structure and files",
    "text": "Repository structure and files\n\nDirectory overview\n\n\n.\n├── README.md\n├── RStudio_init.png\n├── _book\n├── _quarto.yml\n├── chapters\n│   ├── images\n│   ├── re_weight.html.md\n│   ├── re_weight.md\n│   ├── re_weight.qmd\n│   ├── re_weight_files\n│   ├── references.bib\n│   ├── subgroup_analysis.html.md\n│   ├── subgroup_analysis.md\n│   ├── subgroup_analysis.qmd\n│   ├── syvcox_coxph.html.md\n│   ├── syvcox_coxph.md\n│   ├── syvcox_coxph.qmd\n│   ├── syvcox_coxph_files\n│   ├── whole_game.html.md\n│   ├── whole_game.md\n│   ├── whole_game.qmd\n│   └── whole_game_files\n├── functions\n│   ├── covariate_vectors.R\n│   ├── install_on_demand.R\n│   ├── re_weight.R\n│   ├── simulate_flaura.R\n│   ├── source_encore.io_functions.R\n│   └── subgroup.R\n├── images\n│   ├── leyrat_results.png\n│   ├── mi_ps.png\n│   ├── mice.png\n│   ├── nejm_subgroup.jpg\n│   ├── nejm_tbl1.png\n│   └── workflow.png\n├── imputation-ps-workflows.Rproj\n├── index.qmd\n├── index.rmarkdown\n├── literature\n│   ├── MatchThem_vignette.pdf\n│   └── leyrat-et-al-2017-propensity-score-analysis-with-partially-observed-covariates-how-should-multiple-imputation-be-used.pdf\n├── references.bib\n├── renv\n│   ├── activate.R\n│   ├── library\n│   ├── settings.json\n│   └── staging\n├── renv.lock\n└── site_libs\n    ├── bootstrap\n    ├── clipboard\n    ├── quarto-html\n    ├── quarto-nav\n    └── quarto-search",
    "crumbs": [
      "<span class='chapter-number'>1</span>  <span class='chapter-title'>README</span>"
    ]
  },
  {
    "objectID": "chapters/whole_game.html",
    "href": "chapters/whole_game.html",
    "title": "2  The whole game",
    "section": "",
    "text": "2.1 Background\nENCORE",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>The whole game</span>"
    ]
  },
  {
    "objectID": "chapters/whole_game.html#background",
    "href": "chapters/whole_game.html#background",
    "title": "2  The whole game",
    "section": "",
    "text": "In 2022, nearly every third drug approval was granted in the field of oncology (tendency ↑)(Mullard 2022)\nDecision-makers increasingly rely on real-world evidence (RWE) generated from routine-care health data such as electronic health records (EHR) to evaluate the comparative safety and effectiveness of novel cancer therapies\n\n\n\nThe ENCORE project is an RCT DUPLICATE expansion to oncology which is going to emulate 12 randomized clinical trials using multiple EHR data sources. The process includes an emphasis on transparency with documented assessment of data fitness of the RWD source for each trial and conducting extensive sensitivity analyses to assess robustness of findings and trial eligibility criteria.\nPartially observed covariates/confounders are a common and pervasive challenge\nTo date, most oncology studies utilizing RWD have relied on complete case analysis although assumptions for a complete case analysis (missing completely at random [MCAR]) are even stronger than those (missing at random [MAR]) for multiple imputation (MI). Besides this, MI has additional advantages:\n\nAll patients are retained\nFlexible modeling (parametric, non-parametric)\nCan incorporate additional information (auxiliary covariates) to make the MAR assumption more likely\nRealistic variance estimation (Rubin’s rule)\n\nHowever:\n\nNot much is known about how to use multiple imputation in combination with propensity score-based approaches\nComputational implementation can be complex",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>The whole game</span>"
    ]
  },
  {
    "objectID": "chapters/whole_game.html#objective",
    "href": "chapters/whole_game.html#objective",
    "title": "2  The whole game",
    "section": "2.2 Objective",
    "text": "2.2 Objective\n\n\n\n\n\n\nObjective\n\n\n\nTo establish a computationally reproducible workflow that streamlines multiple imputation &gt; propensity score matching/weighting &gt; survival analysis workflows in a transparent fashion\n\n\n\n\n\n\n\n\nFigure 2.1: Streamlined workflow to approach partially observed covariate data in oncology trial emulations.",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>The whole game</span>"
    ]
  },
  {
    "objectID": "chapters/whole_game.html#leyrat-et-al.-simulation-study",
    "href": "chapters/whole_game.html#leyrat-et-al.-simulation-study",
    "title": "2  The whole game",
    "section": "2.3 Leyrat et al. simulation study",
    "text": "2.3 Leyrat et al. simulation study\nOne of the most comprehensive and influental simulation studies that addressed the question on how to combine multiple imputation with propensity scores (IPTW weighting) was published in 2019 by Leyrat et al. (Leyrat et al. 2019). In this study, the authors looked at three different potential ways:\n\nMIte: MI &gt; PS estimation &gt; Outcome model for each PS model &gt; Pooling of results\nMIps: MI &gt; PS estimation &gt; PS pooling across datasets &gt; single outcome model\nMIpar: MI &gt; Pooling of covariate parameters &gt; single PS model &gt; single outcome model\n\nAdditional questions that were also addressed:\n\nShould outcome be included in imputation model?\nHow to estimate variance of IPTW estimator in context of MIte or MIps or MIpar?\n\n\n\n\n\n\n\nFigure 2.2: Illustration of potential approaches that could be considered after multiple imputation (MI) of the partially observed covariates are missing values on the original dataset.\n\n\n\n\n2.3.1 Simulation study results\n\nMIte performed best in terms of bias, standardized differences/balancing, coverage rate and variance estimation\n\nMI &gt; PS estimation &gt; Outcome model for each PS model &gt; Pooling of results\n\nStandard IPTW variance estimation is valid for MIte\nOutcome must be included in imputation model\n\n\n\n\n\n\n\nFigure 2.3: Leyrat et al. simulation study results.\n\n\n\n\n\n2.3.2 Implementation in MatchThem R package\nTo streamline the implementation of multiple imputation &gt; propensity score workflows, Farhad Pishgar, Noah Greifer, Clémence Leyrat and Elizabeth Stuart developed the MatchThem package (Pishgar et al. 2021) which relies on the functionality provided by the mice, MatchIt, and WeightIt packages. An exemplary illustration on how to use the package in a survival analysis context is given in Chapter 3 (cheatsheet).",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>The whole game</span>"
    ]
  },
  {
    "objectID": "chapters/whole_game.html#references",
    "href": "chapters/whole_game.html#references",
    "title": "2  The whole game",
    "section": "2.4 References",
    "text": "2.4 References",
    "crumbs": [
      "<span class='chapter-number'>2</span>  <span class='chapter-title'>The whole game</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html",
    "href": "chapters/syvcox_coxph.html",
    "title": "3  Application in Cox PH models",
    "section": "",
    "text": "3.1 Data generation\nWe use the simulate_flaura() function to simulate a realistic oncology comparative effectiveness analytic cohort dataset with similar distributions to FLAURA, a randomized controlled trial that evaluated the efficacy and safety of osimertinib to standard-of-care (SoC) tyrosine kinase inhibitors (TKIs) in advanced NSCLC patients with a sensitizing EGFR mutation.\nThe following cohort resembles distributions observed in the EHR-derived EDB1dataset used in ENCORE. Note: the values of some continuous covariates (labs) are displayed after log/log-log transformation.\n# load example dataset with missing observations\ndata_miss &lt;- simulate_flaura(\n  n_total = 3500, \n  seed = 42, \n  include_id = FALSE, \n  imposeNA = TRUE,\n  propNA = .33\n  )\n\n# crate Table 1\ndata_miss |&gt; \n  tbl_summary(\n    by = \"treat\", \n    include = table1_covariates$covariate,\n    label = table1_labels\n    ) |&gt; \n  add_overall() |&gt; \n  modify_header(\n    label ~ \"**Patient characteristic**\",\n    stat_0 ~ \"**Total** &lt;br&gt; N = {N}\",\n    stat_1 ~ \"**Comparator** &lt;br&gt; N = {n} &lt;br&gt; ({style_percent(p, digits=1)}%)\",\n    stat_2 ~ \"**Exposure** &lt;br&gt; N = {n} &lt;br&gt; ({style_percent(p, digits=1)}%)\"\n    ) |&gt; \n  modify_spanning_header(c(\"stat_1\", \"stat_2\") ~ \"**Treatment received**\") |&gt; \n  modify_caption(\"**Table 1. Patient Characteristics**\")\n\n\n\n\n\nTable 1. Patient Characteristics\n\n\n\n\n\n\n\n\nPatient characteristic\nTotal  N = 3500\n1\n\nTreatment received\n\n\n\nComparator  N = 1487  (42.5%)\n1\nExposure  N = 2013  (57.5%)\n1\n\n\n\n\nAge at index date\n69 (64, 74)\n69 (64, 74)\n69 (64, 74)\n\n\nSex\n1,146 (33%)\n494 (33%)\n652 (32%)\n\n\nRace\n\n\n\n\n\n\n\n\n    Asian\n835 (36%)\n347 (35%)\n488 (36%)\n\n\n    Other\n54 (2.3%)\n22 (2.2%)\n32 (2.4%)\n\n\n    White\n1,449 (62%)\n625 (63%)\n824 (61%)\n\n\n    Unknown\n1,162\n493\n669\n\n\nSmoking history\n1,033 (44%)\n482 (48%)\n551 (41%)\n\n\n    Unknown\n1,162\n493\n669\n\n\nECOG\n1,327 (57%)\n583 (59%)\n744 (55%)\n\n\n    Unknown\n1,162\n493\n669\n\n\nIndex year\n\n\n\n\n\n\n\n\n    &lt;2018\n3,324 (95%)\n1,400 (94%)\n1,924 (96%)\n\n\n    2018+\n176 (5.0%)\n87 (5.9%)\n89 (4.4%)\n\n\n\n1\nMedian (Q1, Q3); n (%)",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#step-1---multiple-imputation",
    "href": "chapters/syvcox_coxph.html#step-1---multiple-imputation",
    "title": "3  Application in Cox PH models",
    "section": "3.2 Step 1 - Multiple imputation",
    "text": "3.2 Step 1 - Multiple imputation\nThe first step after deriving the analytic cohort includes the creation of multiple imputed datasets using mice R package(Buuren and Groothuis-Oudshoorn 2011).\n\nThe mice algorithm is one particular instance of a fully conditionally specified model. The algorithm starts with a random draw from the observed data, and imputes the incomplete data in a variable-by-variable fashion. One iteration consists of one cycle through all \\(Y_j\\).\n\n\n\n\nMICE algorithm for imputation of multivariate missing data.\n\n\nThe number of iterations \\(M\\) (= number of imputed datasets) in this example is 10, but in ENCORE we follow Stef van Buuren’s advice:\n\n[…] if calculation is not prohibitive, we may set \\(M\\) to the average percentage of missing data.\n(Flexible imputation of Missing Data, Sub-chapter 2.8)\n\nFollowing the results of various simulation studies (Shah et al. 2014; Weberpals et al. 2024), we use a non-parametric (random forest-based) imputation approach as the actual imputation algorithm.\n\n\n\n\n\n\nAdvantages of non-parametric imputation approaches\n\n\n\n\nParametric imputation models have to be correctly specified, i.e. also have to explicitly model nonlinear and non-additive covariate relationships\nMany imputation algorithms are not prepared for mixed type of data\nPopular: random forest-based algorithms\n\nfor each variable random forest is fit on the observed part and then predicts the missing part\nmissForest(Stekhoven and Bühlmann 2012) provides OOB error but only provides single imputations\nAlternatives: rf, cart in mice package (Buuren and Groothuis-Oudshoorn 2011)\n\n\n\n\nNote: In this example we utilize the futuremice() instead of the legacy mice() function to run the mice imputation across 9 cores in parallel.\n\n# impute data\ndata_imp &lt;- futuremice(\n  parallelseed = 42,\n  n.core = parallel::detectCores()-1,\n  data = data_miss,\n  method = \"rf\",\n  m = 10,\n  print = FALSE\n  )\n\nThe imputation step creates an object of class…\n\nclass(data_imp)\n\n[1] \"mids\"\n\n\n…which stands for multiple imputed datasets. It contains important information on the imputation procedure and the actual imputed datasets.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#step-2---propensity-score-matching-and-weighting",
    "href": "chapters/syvcox_coxph.html#step-2---propensity-score-matching-and-weighting",
    "title": "3  Application in Cox PH models",
    "section": "3.3 Step 2 - Propensity score matching and weighting",
    "text": "3.3 Step 2 - Propensity score matching and weighting\nApply propensity score matching and weighting with replacement within in each imputed dataset. As pointed in Section 2.3.1, the MIte approach performed best in terms of bias, standardized differences/balancing, coverage rate and variance estimation. In MatchThem this approach is referred to a within approach (performing matching within each dataset), while the inferior MIps approach (estimating propensity scores within each dataset, averaging them across datasets, and performing matching using the averaged propensity scores in each dataset) is referred to as across approach. Since MIte/within has been shown to have superior performance in most cases, we only illustrate this approach here.\nLet’s assume we fit the following propensity score model within each imputed dataset.\n\n# apply propensity score matching on mids object\nps_form &lt;- as.formula(paste(\"treat ~\", paste(covariates_for_ps, collapse = \" + \")))\nps_form\n\ntreat ~ dem_age_index_cont + dem_sex_cont + c_smoking_history + \n    c_number_met_sites + c_hemoglobin_g_dl_cont + c_urea_nitrogen_mg_dl_cont + \n    c_platelets_10_9_l_cont + c_calcium_mg_dl_cont + c_glucose_mg_dl_cont + \n    c_lymphocyte_leukocyte_ratio_cont + c_alp_u_l_cont + c_protein_g_l_cont + \n    c_alt_u_l_cont + c_albumin_g_l_cont + c_bilirubin_mg_dl_cont + \n    c_chloride_mmol_l_cont + c_monocytes_10_9_l_cont + c_eosinophils_leukocytes_ratio_cont + \n    c_ldh_u_l_cont + c_hr_cont + c_sbp_cont + c_oxygen_cont + \n    c_ecog_cont + c_neutrophil_lymphocyte_ratio_cont + c_bmi_cont + \n    c_ast_alt_ratio_cont + c_stage_initial_dx_cont + dem_race + \n    dem_region + dem_ses + c_time_dx_to_index\n\n\n\nMatchingWeighting\n\n\nThe matching step happens using the matchthem() function, which is a wrapper around the matchit() function. This function not only provides the functionality to match on the propensity score, but also to perform (coarsened) exact matching, cardinality matching, genetic matching and more. In this example, we use a simple 1:1 nearest neighbor matching on the propensity score (estimated through logistic regression) without replacement with a caliper of 1% of the standard deviation of the propensity score.\n\n# matching\nmimids_data &lt;- matchthem(\n  formula = ps_form,\n  datasets = data_imp,\n  approach = 'within',\n  method = 'nearest',\n  distance = \"glm\",\n  link = \"logit\",\n  caliper = 0.01,\n  ratio = 1,\n  replace = F\n  )\n\n# print summary for matched dataset #1\nmimids_data\n\nA matchit object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score [caliper]\n             - estimated with logistic regression\n - caliper: &lt;distance&gt; (0.001)\n - number of obs.: 3500 (original), 2672 (matched)\n - target estimand: ATT\n - covariates: dem_age_index_cont, dem_sex_cont, c_smoking_history, c_number_met_sites, c_hemoglobin_g_dl_cont, c_urea_nitrogen_mg_dl_cont, c_platelets_10_9_l_cont, c_calcium_mg_dl_cont, c_glucose_mg_dl_cont, c_lymphocyte_leukocyte_ratio_cont, c_alp_u_l_cont, c_protein_g_l_cont, c_alt_u_l_cont, c_albumin_g_l_cont, c_bilirubin_mg_dl_cont, c_chloride_mmol_l_cont, c_monocytes_10_9_l_cont, c_eosinophils_leukocytes_ratio_cont, c_ldh_u_l_cont, c_hr_cont, c_sbp_cont, c_oxygen_cont, c_ecog_cont, c_neutrophil_lymphocyte_ratio_cont, c_bmi_cont, c_ast_alt_ratio_cont, c_stage_initial_dx_cont, dem_race, dem_region, dem_ses, c_time_dx_to_index\n\n\nThe resulting “mimids” object contains the original imputed data and the output of the calls to matchit() applied to each imputed dataset.\n\n\nThe weighting step is performed very similarly using the weightthem() function. In this example weapply SMR weighting to arrive at the same ATT estimand as matching which is indicated through the estimand = \"ATT\" argument. In case we wanted to weight patients based on overlap weights, estimand = \"AT0\" would need to be specified (which is one of the sensitivity analyses in the FLAURA protocol).\nTo mitigate the risks of extreme weights, the subsequent trim() function truncates large weights by setting all weights higher than that at a given quantile (in this example the 95% quantile) to the weight at the quantile. Since we specify lower = TRUE, this is done symmetrically also with the 5% quantile.\n\n# SMR weighting\nwimids_data &lt;- weightthem(\n  formula = ps_form,\n  datasets = data_imp,\n  approach = 'within',\n  method = \"glm\",\n  estimand = \"ATT\"\n  )\n\n# trim extreme weights\nwimids_data &lt;- trim(\n  x = wimids_data, \n  at = .95, \n  lower = TRUE\n  )\n\nwimids_data\n\nA weightit object\n - method: \"glm\" (propensity score weighting with GLM)\n - number of obs.: 3500\n - sampling weights: none\n - treatment: 2-category\n - estimand: ATT (focal: 1)\n - covariates: dem_age_index_cont, dem_sex_cont, c_smoking_history, c_number_met_sites, c_hemoglobin_g_dl_cont, c_urea_nitrogen_mg_dl_cont, c_platelets_10_9_l_cont, c_calcium_mg_dl_cont, c_glucose_mg_dl_cont, c_lymphocyte_leukocyte_ratio_cont, c_alp_u_l_cont, c_protein_g_l_cont, c_alt_u_l_cont, c_albumin_g_l_cont, c_bilirubin_mg_dl_cont, c_chloride_mmol_l_cont, c_monocytes_10_9_l_cont, c_eosinophils_leukocytes_ratio_cont, c_ldh_u_l_cont, c_hr_cont, c_sbp_cont, c_oxygen_cont, c_ecog_cont, c_neutrophil_lymphocyte_ratio_cont, c_bmi_cont, c_ast_alt_ratio_cont, c_stage_initial_dx_cont, dem_race, dem_region, dem_ses, c_time_dx_to_index\n - weights trimmed at 5% and 95%\n\n\nThe resulting “wimids” object contains the original imputed data and the output of the calls to weightit() applied to each imputed dataset.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#step-3---balance-assessment",
    "href": "chapters/syvcox_coxph.html#step-3---balance-assessment",
    "title": "3  Application in Cox PH models",
    "section": "3.4 Step 3 - Balance assessment",
    "text": "3.4 Step 3 - Balance assessment\nThe inspection of balance assessment in multiple imputed and matched/weighted data can be done in a similar way as with a single complete dataset. For illustration we just look at the matched datasets, but the exact same principles also apply to the weighted datasets.\n\nBalance tableCovariate balance (conditional exchangeability)Distributional balance (positivity)Power calculations\n\n\n\n\n\nTable 3.1: Covariate balance table.\n\n\n# create balance table\nbalance_table &lt;- bal.tab(\n  x = mimids_data, \n  stats = \"m\",\n  abs = TRUE\n  )\n\nbalance_table\n\nBalance summary across all imputations\n                                        Type Mean.Diff.Adj Max.Diff.Adj\ndistance                            Distance        0.0052       0.0056\ndem_age_index_cont                   Contin.        0.0164       0.0431\ndem_sex_cont                          Binary        0.0038       0.0095\nc_smoking_history                     Binary        0.0071       0.0135\nc_number_met_sites                   Contin.        0.0095       0.0243\nc_hemoglobin_g_dl_cont               Contin.        0.0080       0.0196\nc_urea_nitrogen_mg_dl_cont           Contin.        0.0144       0.0405\nc_platelets_10_9_l_cont              Contin.        0.0123       0.0367\nc_calcium_mg_dl_cont                 Contin.        0.0146       0.0287\nc_glucose_mg_dl_cont                 Contin.        0.0138       0.0304\nc_lymphocyte_leukocyte_ratio_cont    Contin.        0.0115       0.0262\nc_alp_u_l_cont                       Contin.        0.0143       0.0250\nc_protein_g_l_cont                   Contin.        0.0144       0.0259\nc_alt_u_l_cont                       Contin.        0.0123       0.0298\nc_albumin_g_l_cont                   Contin.        0.0148       0.0418\nc_bilirubin_mg_dl_cont               Contin.        0.0213       0.0347\nc_chloride_mmol_l_cont               Contin.        0.0147       0.0328\nc_monocytes_10_9_l_cont              Contin.        0.0154       0.0284\nc_eosinophils_leukocytes_ratio_cont  Contin.        0.0156       0.0216\nc_ldh_u_l_cont                       Contin.        0.0139       0.0284\nc_hr_cont                            Contin.        0.0124       0.0335\nc_sbp_cont                           Contin.        0.0118       0.0263\nc_oxygen_cont                        Contin.        0.0143       0.0348\nc_ecog_cont                           Binary        0.0054       0.0134\nc_neutrophil_lymphocyte_ratio_cont   Contin.        0.0149       0.0270\nc_bmi_cont                           Contin.        0.0153       0.0392\nc_ast_alt_ratio_cont                 Contin.        0.0179       0.0427\nc_stage_initial_dx_cont              Contin.        0.0105       0.0316\ndem_race_Asian                        Binary        0.0060       0.0174\ndem_race_Other                        Binary        0.0011       0.0030\ndem_race_White                        Binary        0.0070       0.0166\ndem_region_Midwest                    Binary        0.0040       0.0090\ndem_region_Northeast                  Binary        0.0037       0.0118\ndem_region_South                      Binary        0.0042       0.0150\ndem_region_West                       Binary        0.0049       0.0089\ndem_ses                              Contin.        0.0113       0.0370\nc_time_dx_to_index                   Contin.        0.0095       0.0245\n\nAverage sample sizes across imputations\n               0      1\nAll       1487.  2013. \nMatched   1349.8 1349.8\nUnmatched  137.2  663.2\n\n\n\n\n\n\n\nlove.plot(\n  x = mimids_data,\n  abs = TRUE,\n  thresholds = 0.1, \n  drop.distance = TRUE,\n  var.order = \"unadjusted\",\n  colors = c(\"orange\", \"blue\"), \n  stars = \"std\",\n  shapes = 17, \n  size = 4, \n  grid = TRUE,\n  position = \"top\"\n  )\n\n\n\n\n\n\n\nFigure 3.1: Covariate balance plot (love plot).\n\n\n\n\n\n\n\n\nbal.plot(\n  x = mimids_data,\n  var.name = \"distance\",\n  which = \"both\",\n  which.imp = .none,\n  colors = c(\"orange\", \"blue\")\n  )\n\n\n\n\n\n\n\n\n\n\nFor power calculations, we use the method proposed by Schoenfeld (Schoenfeld 1983) to compute 1 - type II error rate \\(\\beta\\) . For this, we assume the following:\n\n\\(\\alpha\\) = 0.05 (two-sided)\n% exposed (1:1 matching in main analysis) = 50%\nHR (desired) = 0.8\nEvents = as observed in data\n\nSince we have multiple imputed and matched datasets, we need to average the number of events before before computing \\(\\beta\\).\n\n# make long dataset\ndata_long &lt;- MatchThem::complete(\n  # datasets\n  data = mimids_data, \n  # produces a dataset with multiply imputed datasets stacked vertically\n  action = \"long\", \n  # do NOT include observations with a zero estimated weight (non-matched)\n  all = FALSE, \n  # do NOT include original dataset with missing values\n  include = FALSE\n  )\n\n# compute average number of events\n# by summing up all events\n# and dividing by number of imputed datasets\navg_events &lt;- sum(data_long$death_itt)/mimids_data$object$m\n\n# compute beta\nbeta_gsDesign &lt;- nEvents(\n  alpha = 0.05, \n  sided = 2,\n  n = avg_events,\n  hr = .8,\n  ratio = 1,\n  tbl = TRUE\n  )\n\n# print results\ncat(\"beta is\", beta_gsDesign$beta, \"\\n\")\n\nbeta is 7.069689e-05 \n\ncat(\"power is\", (1-beta_gsDesign$beta)*100, \"% \\n\")\n\npower is 99.99293 % \n\n# gsDesign table\nbeta_gsDesign\n\n   hr      n alpha sided         beta     Power     delta ratio hr0         se\n1 0.8 2670.5  0.05     2 7.069689e-05 0.9999293 0.1115718     1   1 0.03870203",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#step-4---estimation-of-marginal-treatment-effects",
    "href": "chapters/syvcox_coxph.html#step-4---estimation-of-marginal-treatment-effects",
    "title": "3  Application in Cox PH models",
    "section": "3.5 Step 4 - Estimation of marginal treatment effects",
    "text": "3.5 Step 4 - Estimation of marginal treatment effects\nNext, we compare the marginal treatment effect estimates coming from a Cox proportional hazards model after propensity score matching and weighting as implemented in the coxph() and in the svycoxph() functions.\nFrom the MatchThem documentation:\n\n\n\n\n\n\nImportant\n\n\n\n\nwith() applies the supplied model in expr to the (matched or weighted) multiply imputed datasets, automatically incorporating the (matching) weights when possible. The argument to expr should be of the form glm(y ~ z, family = quasibinomial), for example, excluding the data or weights argument, which are automatically supplied.\nFunctions from the survey package, such as svyglm(), are treated a bit differently. No svydesign object needs to be supplied because with() automatically constructs and supplies it with the imputed dataset and estimated weights. When cluster = TRUE (or with() detects that pairs should be clustered; see the cluster argument above), pair membership is supplied to the ids argument of svydesign().\nAfter weighting using weightthem(), glm_weightit() should be used as the modeling function to fit generalized linear models. It correctly produces robust standard errors that account for estimation of the weights, if possible. See WeightIt::glm_weightit() for details. Otherwise, svyglm() should be used rather than glm() in order to correctly compute standard errors.\nFor Cox models, coxph() will produce approximately correct standard errors when used with weighting, but svycoxph() will produce more accurate standard errors when matching is used.\n\n\n\n\nMatchingWeighting\n\n\nWe now want to compare treatment effect estimates for treat when computed (a) using coxph (survival package) and (b) svycoxph (survey package). More information on estimating treatment effects after matching is provided in https://kosukeimai.github.io/MatchIt/articles/estimating-effects.html#survival-outcomes\n\n3.5.0.1 coxph\n\n# coxph result\ncoxph_results &lt;- with(\n  data = mimids_data,\n  expr = coxph(formula = Surv(fu_itt_months, death_itt) ~ treat, \n               weights = weights, \n               cluster = subclass,\n               robust = TRUE\n               )\n  ) |&gt; \n  pool() |&gt; \n  tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  mutate(package = \"survival\") |&gt; \n  select(package, term, estimate, std.error, conf.low, conf.high) \n\ncoxph_results\n\n\n\n3.5.0.2 svycoxph\n\n# svycoxph result\nsvycoxph_results &lt;- with(\n  data = mimids_data,\n  expr = svycoxph(formula = Surv(fu_itt_months, death_itt) ~ treat),\n  cluster = TRUE\n  ) |&gt; \n  pool() |&gt; \n  tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  mutate(package = \"survey\") |&gt; \n  select(package, term, estimate, std.error, conf.low, conf.high)\n\nsvycoxph_results\n\n\n\n3.5.0.3 Summary\n\nrbind(coxph_results, svycoxph_results)\n\n   package  term  estimate  std.error  conf.low conf.high\n1 survival treat 0.6980895 0.04378617 0.6402933 0.7611027\n2   survey treat 0.6980895 0.04379887 0.6403105 0.7610823\n\n\n\n\n\n\n3.5.0.4 coxph\n\n# coxph result\ncoxph_results &lt;- with(\n  data = wimids_data,\n  expr = coxph(formula = Surv(fu_itt_months, death_itt) ~ treat,\n               weights = weights, \n               robust = TRUE\n               )\n  ) |&gt; \n  pool() |&gt; \n  tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  mutate(package = \"survival\") |&gt; \n  select(package, term, estimate, std.error, conf.low, conf.high) \n\ncoxph_results\n\n\n\n3.5.0.5 svycoxph\n\n# svycoxph result\nsvycoxph_results &lt;- with(\n  data = wimids_data,\n  expr = svycoxph(formula = Surv(fu_itt_months, death_itt) ~ treat),\n  cluster = TRUE\n  ) |&gt; \n  pool() |&gt; \n  tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  mutate(package = \"survey\") |&gt; \n  select(package, term, estimate, std.error, conf.low, conf.high) \n\nsvycoxph_results\n\n\n\n3.5.0.6 Summary\n\nrbind(coxph_results, svycoxph_results)\n\n   package  term  estimate  std.error  conf.low conf.high\n1 survival treat 0.7031986 0.03545543 0.6559682 0.7538297\n2   survey treat 0.7031986 0.03546033 0.6559784 0.7538180",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#session-info",
    "href": "chapters/syvcox_coxph.html#session-info",
    "title": "3  Application in Cox PH models",
    "section": "3.6 Session info",
    "text": "3.6 Session info\nScript runtime: 0.37 minutes.\n\nLoaded packagesSession infoRepositories\n\n\n\npander::pander(subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)))\n\n\n\n\n\n\n\n\n\n \npackage\nloadedversion\n\n\n\n\ncobalt\ncobalt\n4.5.5\n\n\ndplyr\ndplyr\n1.1.4\n\n\nfurrr\nfurrr\n0.3.1\n\n\nfuture\nfuture\n1.34.0\n\n\ngsDesign\ngsDesign\n3.6.4\n\n\ngtsummary\ngtsummary\n2.0.1\n\n\nhere\nhere\n1.0.1\n\n\nMatchThem\nMatchThem\n1.2.1\n\n\nMatrix\nMatrix\n1.7-0\n\n\nmice\nmice\n3.16.0\n\n\nparallelly\nparallelly\n1.38.0\n\n\nranger\nranger\n0.16.0\n\n\nsurvey\nsurvey\n4.4-2\n\n\nsurvival\nsurvival\n3.5-8\n\n\n\n\n\n\n\n\npander::pander(sessionInfo())\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nlocale: en_US.UTF-8||en_US.UTF-8||en_US.UTF-8||C||en_US.UTF-8||en_US.UTF-8\nattached base packages: grid, stats, graphics, grDevices, datasets, utils, methods and base\nother attached packages: gsDesign(v.3.6.4), cobalt(v.4.5.5), furrr(v.0.3.1), future(v.1.34.0), ranger(v.0.16.0), parallelly(v.1.38.0), gtsummary(v.2.0.1), here(v.1.0.1), survey(v.4.4-2), Matrix(v.1.7-0), MatchThem(v.1.2.1), mice(v.3.16.0), survival(v.3.5-8) and dplyr(v.1.1.4)\nloaded via a namespace (and not attached): tidyselect(v.1.2.1), farver(v.2.1.2), fastmap(v.1.2.0), digest(v.0.6.37), rpart(v.4.1.23), lifecycle(v.1.0.4), magrittr(v.2.0.3), compiler(v.4.4.0), rlang(v.1.1.4), sass(v.0.4.9), tools(v.4.4.0), utf8(v.1.2.4), yaml(v.2.3.10), gt(v.0.11.0), knitr(v.1.48), labeling(v.0.4.3), htmlwidgets(v.1.6.4), xml2(v.1.3.6), r2rtf(v.1.1.1), withr(v.3.0.1), purrr(v.1.0.2), nnet(v.7.3-19), fansi(v.1.0.6), jomo(v.2.7-6), xtable(v.1.8-4), colorspace(v.2.1-1), ggplot2(v.3.5.1), globals(v.0.16.3), scales(v.1.3.0), iterators(v.1.0.14), MASS(v.7.3-60.2), cli(v.3.6.3), rmarkdown(v.2.28), crayon(v.1.5.3), generics(v.0.1.3), rstudioapi(v.0.16.0), sessioninfo(v.1.2.2), commonmark(v.1.9.1), minqa(v.1.2.8), DBI(v.1.2.3), pander(v.0.6.5), stringr(v.1.5.1), splines(v.4.4.0), assertthat(v.0.2.1), parallel(v.4.4.0), base64enc(v.0.1-3), mitools(v.2.4), vctrs(v.0.6.5), WeightIt(v.1.3.0), boot(v.1.3-30), glmnet(v.4.1-8), jsonlite(v.1.8.8), mitml(v.0.4-5), listenv(v.0.9.1), locfit(v.1.5-9.10), foreach(v.1.5.2), tidyr(v.1.3.1), glue(v.1.7.0), nloptr(v.2.1.1), pan(v.1.9), chk(v.0.9.2), codetools(v.0.2-20), stringi(v.1.8.4), shape(v.1.4.6.1), gtable(v.0.3.5), lme4(v.1.1-35.5), munsell(v.0.5.1), tibble(v.3.2.1), pillar(v.1.9.0), htmltools(v.0.5.8.1), R6(v.2.5.1), rprojroot(v.2.0.4), evaluate(v.0.24.0), lattice(v.0.22-6), markdown(v.1.13), backports(v.1.5.0), cards(v.0.2.1), tictoc(v.1.2.1), MatchIt(v.4.5.5), broom(v.1.0.6), renv(v.1.0.7), simsurv(v.1.0.0), Rcpp(v.1.0.13), nlme(v.3.1-164), xfun(v.0.47) and pkgconfig(v.2.0.3)\n\n\n\n\n\npander::pander(options('repos'))\n\n\nrepos:\n\n\n\n\n\n\nREPO_NAME\n\n\n\n\nhttps://packagemanager.posit.co/cran/latest",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/syvcox_coxph.html#section",
    "href": "chapters/syvcox_coxph.html#section",
    "title": "3  Application in Cox PH models",
    "section": "3.7 ",
    "text": "3.7 \n\n\n\n\n\n\nBuuren, Stef van, and Karin Groothuis-Oudshoorn. 2011. “Mice: Multivariate Imputation by Chained Equations in r” 45: 1–67. https://doi.org/10.18637/jss.v045.i03.\n\n\nLumley, Thomas. 2024. “Survey: Analysis of Complex Survey Samples.”\n\n\nPishgar, Farhad, Noah Greifer, Clémence Leyrat, and Elizabeth Stuart. 2021. “MatchThem: Matching and Weighting after Multiple Imputation.” R Journal 13 (2): 292–305. https://doi.org/10.32614/RJ-2021-073.\n\n\nSchoenfeld, David A. 1983. “Sample-Size Formula for the Proportional-Hazards Regression Model.” Biometrics, 499–503.\n\n\nShah, Anoop D., Jonathan W. Bartlett, James Carpenter, Owen Nicholas, and Harry Hemingway. 2014. “Comparison of random forest and parametric imputation models for imputing missing data using MICE: a CALIBER study.” American Journal of Epidemiology 179 (6): 764–74. https://doi.org/10.1093/aje/kwt312.\n\n\nStekhoven, Daniel J., and Peter Bühlmann. 2012. “MissForestnon-Parametric Missing Value Imputation for Mixed-Type Data.” Bioinformatics 28 (1): 112–18. https://doi.org/10.1093/bioinformatics/btr597.\n\n\nTherneau, Terry M. 2024. “A Package for Survival Analysis in r.” https://CRAN.R-project.org/package=survival.\n\n\nWeberpals, Janick, Sudha Raman, Pamela Shaw, Hana Lee, Massimiliano Russo, Bradley Hammill, Sengwee Toh, et al. 2024. “A Principled Approach to Characterize and Analyze Partially Observed Confounder Data from Electronic Health Records.” Clinical Epidemiology Volume 16 (May): 329–43. https://doi.org/10.2147/clep.s436131.",
    "crumbs": [
      "<span class='chapter-number'>3</span>  <span class='chapter-title'>Application in Cox PH models</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html",
    "href": "chapters/re_weight.html",
    "title": "4  Re-weighting to a target population",
    "section": "",
    "text": "4.1 Data generation\nWe use the simulate_flaura() function to simulate a realistic oncology comparative effectiveness cohort analytic dataset.\nShow the code\n# load example dataset with missing observations\ndata_miss &lt;- simulate_flaura(\n  n_total = 3500, \n  seed = 41, \n  include_id = FALSE, \n  imposeNA = TRUE,\n  propNA = .33\n  ) |&gt; \n  # anesrake works best with factor variables\n  # create age category with age less than 65\n  mutate(dem_age_lt65 = factor(ifelse(dem_age_index_cont &lt; 65, \"&lt;65\", \"65+\"))) |&gt; \n  # convert dem_race into a binary Asian vs. non-Asian \n  mutate(dem_race = factor(ifelse(dem_race == \"Asian\", \"Asian\", \"Non-Asian\"))) |&gt;\n  # convert dem_sex_cont into a factor \n  mutate(dem_sex_cont = factor(ifelse(dem_sex_cont == \"1\", \"Male\", \"Female\"))) |&gt; \n  # convert dem_sex_cont into a factor \n  mutate(c_smoking_history = factor(ifelse(c_smoking_history == TRUE, \"Current/former\", \"Never\"))) |&gt; \n  # convert c_ecog_cont into a factor \n  mutate(across(c(c_ecog_cont), function(x) factor(as.character(x))))",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#multiple-imputation",
    "href": "chapters/re_weight.html#multiple-imputation",
    "title": "4  Re-weighting to a target population",
    "section": "4.2 Multiple imputation",
    "text": "4.2 Multiple imputation\nMultiple imputation using mice:\n\n\nShow the code\n# impute data\ndata_imp &lt;- futuremice(\n  parallelseed = 42,\n  n.core = 7,\n  data = data_miss,\n  method = \"rf\",\n  m = 10,\n  print = FALSE\n  )",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#defining-target-distributions",
    "href": "chapters/re_weight.html#defining-target-distributions",
    "title": "4  Re-weighting to a target population",
    "section": "4.3 Defining target distributions",
    "text": "4.3 Defining target distributions\nBefore applying the re-weighting, we need to define the target distributions of patient characteristics that we want to match from the clinical trial using the raking procedure. The following distributions are taken from Table 1 of the FLAURA trial.\n\n\n\nTable 4.1: FLAURA trial Table 1; in OS analysis race was simplified to Asian vs. non-Asian\n\n\n\n\n\n\n\n\nShow the code\n# Define FLAURA distributions for key covariates --------------------------\n# order is as in Table 1\n\n## age (taken from https://www.tagrissohcp.com/metastatic/flaura/efficacy.html)\n# less than 65 years (54%, TRUE) to 65+ (46%, FALSE)\nage_target &lt;- c(.54, .46)\nnames(age_target) &lt;- c(\"&lt;65\", \"65+\")\n\n## sex ---------------------------------------------------------------------\n\n# female (0) to male (1) proportion:\nsex_target &lt;- c(.63, .37) \nnames(sex_target) &lt;- c(\"Female\", \"Male\")\n\n## race --------------------------------------------------------------------\n# asian, non-asian\n# asian (TRUE) to non-asian (FALSE) proportion\n# note: logical variables in dataframe can be matched to a numeric vector of length 2 and ordered with the TRUE target as the first element and the FALSE target as the second element.\nrace_target &lt;- c(.62, .38)\nnames(race_target) &lt;- c(\"Asian\", \"Non-Asian\")\n\n## smoking -----------------------------------------------------------------\n\n# current/former smoker (TRUE) to never smoker (FALSE) proportion\n# note: logical variables in dataframe can be matched to a numeric vector of length 2 and ordered with the TRUE target as the first element and the FALSE target as the second element.\nsmoker_target &lt;- c(.35, .65)\nnames(smoker_target) &lt;- c(\"Current/former\", \"Never\")\n\n## ecog --------------------------------------------------------------------\n\n# ecog 0 to ecog 1 proportion\necog_target &lt;- c(.41, .59)\nnames(ecog_target) &lt;- c(\"0\", \"1\")\n\n# summarize target distributions in a named list vector --------------\ntargets &lt;- list(age_target, sex_target, race_target, smoker_target, ecog_target)\nnames(targets) &lt;- c(\"dem_age_lt65\", \"dem_sex_cont\", \"dem_race\", \"c_smoking_history\", \"c_ecog_cont\")\n\n# print\ntargets\n\n\n$dem_age_lt65\n &lt;65  65+ \n0.54 0.46 \n\n$dem_sex_cont\nFemale   Male \n  0.63   0.37 \n\n$dem_race\n    Asian Non-Asian \n     0.62      0.38 \n\n$c_smoking_history\nCurrent/former          Never \n          0.35           0.65 \n\n$c_ecog_cont\n   0    1 \n0.41 0.59",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#propensity-score-matching-and-re-weighting",
    "href": "chapters/re_weight.html#propensity-score-matching-and-re-weighting",
    "title": "4  Re-weighting to a target population",
    "section": "4.4 Propensity score matching and re-weighting",
    "text": "4.4 Propensity score matching and re-weighting\nIn this step, propensity score matching and re-weighting of key patient characteristics to match those of the original RCT is performed across all imputed datasets.\nThe propensity score model is specified as follows:\n\n\nShow the code\n# apply propensity score matching on mids object\nps_form &lt;- as.formula(paste(\"treat ~\", paste(covariates_for_ps, collapse = \" + \")))\nps_form\n\n\ntreat ~ dem_age_index_cont + dem_sex_cont + c_smoking_history + \n    c_number_met_sites + c_hemoglobin_g_dl_cont + c_urea_nitrogen_mg_dl_cont + \n    c_platelets_10_9_l_cont + c_calcium_mg_dl_cont + c_glucose_mg_dl_cont + \n    c_lymphocyte_leukocyte_ratio_cont + c_alp_u_l_cont + c_protein_g_l_cont + \n    c_alt_u_l_cont + c_albumin_g_l_cont + c_bilirubin_mg_dl_cont + \n    c_chloride_mmol_l_cont + c_monocytes_10_9_l_cont + c_eosinophils_leukocytes_ratio_cont + \n    c_ldh_u_l_cont + c_hr_cont + c_sbp_cont + c_oxygen_cont + \n    c_ecog_cont + c_neutrophil_lymphocyte_ratio_cont + c_bmi_cont + \n    c_ast_alt_ratio_cont + c_stage_initial_dx_cont + dem_race + \n    dem_region + dem_ses + c_time_dx_to_index\n\n\nThe matching and re-weighting is performed using the re_weight() function. This function is a wrapper for matchit() and weightit() in combination with the anesrake() function which performs the raking (= re-weighting) procedure.\nWe apply this function to each imputed dataset. Before doing so, the imputed datasets, which are currently stored as a mids object, needs to be converted to a list of dataframes:\n\n\nShow the code\n# create a mild object containing lists of data.frames\ndata_mild &lt;- mice::complete(data = data_imp, action = \"all\", include = FALSE)\n\nsummary(data_mild)\n\n\n   Length Class      Mode\n1  40     data.frame list\n2  40     data.frame list\n3  40     data.frame list\n4  40     data.frame list\n5  40     data.frame list\n6  40     data.frame list\n7  40     data.frame list\n8  40     data.frame list\n9  40     data.frame list\n10 40     data.frame list\n\n\nThe lapply function loops the function through each dataframe and returns a list of matchit objects which contain imputed &gt; matched &gt; re-weighted datasets. To take advantage of the features that come with the cobalt and matchthem packages, the function stores the raking weights as sampling weights (s.weights).\n\n\nShow the code\n# call match re-weight\nmatchit_out_list &lt;- lapply(\n  # list of dataframes\n  X = data_mild, \n  # call function\n  FUN = re_weight,\n  # target distributions\n  targets = targets,\n  # should matching or weighting be performed\n  matching_weighting = \"matching\",\n  # matching arguments passed on to matchit() function\n  formula = ps_form,\n  ratio = 1,\n  method = \"nearest\",\n  distance = \"glm\",\n  link = \"logit\",\n  caliper = 0.05,\n  replace = F\n  )\n\n\n[1] \"Raking converged in 9 iterations\"\n[1] \"Raking converged in 12 iterations\"\n[1] \"Raking converged in 14 iterations\"\n[1] \"Raking converged in 9 iterations\"\n[1] \"Raking converged in 10 iterations\"\n[1] \"Raking converged in 8 iterations\"\n[1] \"Raking converged in 9 iterations\"\n[1] \"Raking converged in 10 iterations\"\n[1] \"Raking converged in 14 iterations\"\n[1] \"Raking converged in 10 iterations\"\n[1] \"Raking converged in 11 iterations\"\n[1] \"Raking converged in 9 iterations\"\n[1] \"Raking converged in 8 iterations\"\n\n\nWe can inspect the output of the first imputed &gt; matched &gt; re-weighted dataset.\n\n\nShow the code\nmatchit_out_list[[1]]\n\n\nA matchit object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score [caliper]\n             - estimated with logistic regression\n             - sampling weights not included in estimation\n - caliper: &lt;distance&gt; (0.003)\n - number of obs.: 3500 (original), 2970 (matched)\n - sampling weights: present\n - target estimand: ATT\n - covariates: dem_age_index_cont, dem_sex_cont, c_smoking_history, c_number_met_sites, c_hemoglobin_g_dl_cont, c_urea_nitrogen_mg_dl_cont, c_platelets_10_9_l_cont, c_calcium_mg_dl_cont, c_glucose_mg_dl_cont, c_lymphocyte_leukocyte_ratio_cont, c_alp_u_l_cont, c_protein_g_l_cont, c_alt_u_l_cont, c_albumin_g_l_cont, c_bilirubin_mg_dl_cont, c_chloride_mmol_l_cont, c_monocytes_10_9_l_cont, c_eosinophils_leukocytes_ratio_cont, c_ldh_u_l_cont, c_hr_cont, c_sbp_cont, c_oxygen_cont, c_ecog_cont, c_neutrophil_lymphocyte_ratio_cont, c_bmi_cont, c_ast_alt_ratio_cont, c_stage_initial_dx_cont, dem_race, dem_region, dem_ses, c_time_dx_to_index",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#table-1",
    "href": "chapters/re_weight.html#table-1",
    "title": "4  Re-weighting to a target population",
    "section": "4.5 Table 1",
    "text": "4.5 Table 1\nTo check if the re-weighting process worked, we can extract the matched patients and compare a Table 1 that does not include the weights vs. a Table that considers the weights. For this example, we look at the first imputed &gt; matched &gt; re-weighted dataset.\n\n\nShow the code\n# extract the matched of\nfirst_dataset &lt;- get_matches(\n  object = matchit_out_list[[1]]\n  )\n\n\n\nReminder : The target distributions look like this\n\n\n\nShow the code\ntargets\n\n\n$dem_age_lt65\n &lt;65  65+ \n0.54 0.46 \n\n$dem_sex_cont\nFemale   Male \n  0.63   0.37 \n\n$dem_race\n    Asian Non-Asian \n     0.62      0.38 \n\n$c_smoking_history\nCurrent/former          Never \n          0.35           0.65 \n\n$c_ecog_cont\n   0    1 \n0.41 0.59 \n\n\n\nUnweighted Table 1Weighted Table 1\n\n\n\n\nShow the code\nlibrary(cardx)\nlibrary(smd)\n\n# print\nfirst_dataset |&gt;\n  tbl_summary(\n    by = treat,\n    include = c(dem_age_index_cont, names(targets))\n    ) |&gt; \n  add_difference(test = dplyr::everything() ~ \"smd\") |&gt;\n  add_overall() |&gt;\n  modify_column_hide(columns = \"conf.low\") |&gt; \n  modify_header(\n    label ~ \"**Patient characteristic**\",\n    stat_0 ~ \"**Total** &lt;br&gt; N = {round(N, 2)}\",\n    stat_1 ~ \"**{level}** &lt;br&gt; N = {round(n, 2)} &lt;br&gt; ({style_percent(p, digits=1)}%)\",\n    stat_2 ~ \"**{level}** &lt;br&gt; N = {round(n, 2)} &lt;br&gt; ({style_percent(p, digits=1)}%)\"\n    ) |&gt;\n  modify_spanning_header(c(\"stat_1\", \"stat_2\") ~ \"**Treatment received**\")\n\n\n\n\nTable 4.2: Table 1 BEFORE re-weighting\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPatient characteristic\nTotal  N = 2970\n1\n\nTreatment received\n\nDifference\n2\n\n\n0  N = 1485  (50.0%)\n1\n1  N = 1485  (50.0%)\n1\n\n\n\n\ndem_age_index_cont\n69 (63, 74)\n69 (63, 74)\n69 (64, 74)\n-0.03\n\n\ndem_age_lt65\n\n\n\n\n\n\n0.01\n\n\n    &lt;65\n942 (32%)\n468 (32%)\n474 (32%)\n\n\n\n\n    65+\n2,028 (68%)\n1,017 (68%)\n1,011 (68%)\n\n\n\n\ndem_sex_cont\n\n\n\n\n\n\n0.00\n\n\n    Female\n1,957 (66%)\n978 (66%)\n979 (66%)\n\n\n\n\n    Male\n1,013 (34%)\n507 (34%)\n506 (34%)\n\n\n\n\ndem_race\n\n\n\n\n\n\n0.01\n\n\n    Asian\n1,146 (39%)\n568 (38%)\n578 (39%)\n\n\n\n\n    Non-Asian\n1,824 (61%)\n917 (62%)\n907 (61%)\n\n\n\n\nc_smoking_history\n\n\n\n\n\n\n0.03\n\n\n    Current/former\n1,409 (47%)\n714 (48%)\n695 (47%)\n\n\n\n\n    Never\n1,561 (53%)\n771 (52%)\n790 (53%)\n\n\n\n\nc_ecog_cont\n\n\n\n\n\n\n0.02\n\n\n    0\n1,308 (44%)\n660 (44%)\n648 (44%)\n\n\n\n\n    1\n1,662 (56%)\n825 (56%)\n837 (56%)\n\n\n\n\n\n1\nMedian (Q1, Q3); n (%)\n\n\n2\nStandardized Mean Difference\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nShow the code\n# create survey object \ndata_svy &lt;- svydesign(ids = ~ 1, weights = ~ weights, data = first_dataset)\n\n# print\ndata_svy |&gt;\n  tbl_svysummary(\n    by = treat,\n    include = c(dem_age_index_cont, names(targets))\n    ) |&gt; \n  add_difference(test = dplyr::everything() ~ \"smd\") |&gt;\n  add_overall() |&gt;\n  modify_column_hide(columns = \"conf.low\") |&gt; \n  modify_header(\n    label ~ \"**Patient characteristic**\",\n    stat_0 ~ \"**Total** &lt;br&gt; N = {round(N, 2)}\",\n    stat_1 ~ \"**{level}** &lt;br&gt; N = {round(n, 2)} &lt;br&gt; ({style_percent(p, digits=1)}%)\",\n    stat_2 ~ \"**{level}** &lt;br&gt; N = {round(n, 2)} &lt;br&gt; ({style_percent(p, digits=1)}%)\"\n    ) |&gt;\n  modify_spanning_header(c(\"stat_1\", \"stat_2\") ~ \"**Treatment received**\")\n\n\n\n\nTable 4.3: Table 1 AFTER re-weighting\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\nPatient characteristic\nTotal  N = 2970\n1\n\nTreatment received\n\nDifference\n2\n\n\n0  N = 1471.53  (49.5%)\n1\n1  N = 1498.47  (50.5%)\n1\n\n\n\n\ndem_age_index_cont\n64 (61, 72)\n64 (61, 71)\n64 (61, 72)\n-0.02\n\n\ndem_age_lt65\n\n\n\n\n\n\n0.02\n\n\n    &lt;65\n1,604 (54%)\n787 (53%)\n817 (55%)\n\n\n\n\n    65+\n1,366 (46%)\n684 (47%)\n682 (45%)\n\n\n\n\ndem_sex_cont\n\n\n\n\n\n\n0.04\n\n\n    Female\n1,871 (63%)\n940 (64%)\n931 (62%)\n\n\n\n\n    Male\n1,099 (37%)\n531 (36%)\n567 (38%)\n\n\n\n\ndem_race\n\n\n\n\n\n\n0.01\n\n\n    Asian\n1,841 (62%)\n909 (62%)\n932 (62%)\n\n\n\n\n    Non-Asian\n1,129 (38%)\n563 (38%)\n566 (38%)\n\n\n\n\nc_smoking_history\n\n\n\n\n\n\n0.01\n\n\n    Current/former\n1,040 (35%)\n518 (35%)\n522 (35%)\n\n\n\n\n    Never\n1,931 (65%)\n954 (65%)\n977 (65%)\n\n\n\n\nc_ecog_cont\n\n\n\n\n\n\n0.02\n\n\n    0\n1,218 (41%)\n596 (41%)\n621 (41%)\n\n\n\n\n    1\n1,752 (59%)\n875 (59%)\n877 (59%)\n\n\n\n\n\n1\nMedian (Q1, Q3); n (%)\n\n\n2\nStandardized Mean Difference\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n4.5.1 Comparison of custom function vs. matchthem()\nLastly, we want to make sure that our custom function results in the same matched datasets as the matchthem() function which we use in the main analysis - not considering the re-weighting.\nFor this demonstration, we use the same matching parameters, but without re-weighting after matching in our custom function.\n\n\n\n4.5.2 Custom function\nWe run again our custom function but with targets = NULL to not re-weight any of the included covariates. To convert the returned output of a list of matchit objects into an object of type mimids we use the MatchThem::as.mimids() function.\n\n\nShow the code\n# call match re-weight\nset.seed(42)\nmatchit_out_list &lt;- lapply(\n  X = data_mild, \n  FUN = re_weight,\n  targets = NULL,\n  matching_weighting = \"matching\",\n  formula = ps_form,\n  ratio = 1,\n  method = \"nearest\",\n  distance = \"glm\",\n  link = \"logit\",\n  caliper = 0.05,\n  replace = F\n  )\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nNo target distributions specified, no re-weighting will be performed.\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\nShow the code\n# convert the output into a mimids object\nmimids_data_from_function &lt;- MatchThem::as.mimids(\n  x = matchit_out_list, \n  datasets = data_imp\n  )\n\nmimids_data_from_function\n\n\nPrinting               | dataset: #1\n\n\nA matchit object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score [caliper]\n             - estimated with logistic regression\n - caliper: &lt;distance&gt; (0.003)\n - number of obs.: 3500 (original), 2970 (matched)\n - target estimand: ATT\n - covariates: dem_age_index_cont, dem_sex_cont, c_smoking_history, c_number_met_sites, c_hemoglobin_g_dl_cont, c_urea_nitrogen_mg_dl_cont, c_platelets_10_9_l_cont, c_calcium_mg_dl_cont, c_glucose_mg_dl_cont, c_lymphocyte_leukocyte_ratio_cont, c_alp_u_l_cont, c_protein_g_l_cont, c_alt_u_l_cont, c_albumin_g_l_cont, c_bilirubin_mg_dl_cont, c_chloride_mmol_l_cont, c_monocytes_10_9_l_cont, c_eosinophils_leukocytes_ratio_cont, c_ldh_u_l_cont, c_hr_cont, c_sbp_cont, c_oxygen_cont, c_ecog_cont, c_neutrophil_lymphocyte_ratio_cont, c_bmi_cont, c_ast_alt_ratio_cont, c_stage_initial_dx_cont, dem_race, dem_region, dem_ses, c_time_dx_to_index\n\n\n\n\n4.5.3 matchthem() function\nThe following code resembles the code we would use in the main analysis by implementing the generic matchthem() function.\n\n\nShow the code\n# matching\nset.seed(42)\nmimids_data &lt;- matchthem(\n  datasets = data_imp,\n  formula = ps_form,\n  ratio = 1,\n  method = \"nearest\",\n  distance = \"glm\",\n  link = \"logit\",\n  caliper = 0.05,\n  replace = F\n  )\n\n\n\nMatching Observations  | dataset: #1\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#2\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#3\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#4\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#5\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#6\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#7\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#8\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#9\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n#10\n\n\nWarning: Fewer control units than treated units; not all treated units will get\na match.\n\n\n\n\n\nShow the code\nmimids_data\n\n\nPrinting               | dataset: #1\n\n\nA matchit object\n - method: 1:1 nearest neighbor matching without replacement\n - distance: Propensity score [caliper]\n             - estimated with logistic regression\n - caliper: &lt;distance&gt; (0.003)\n - number of obs.: 3500 (original), 2970 (matched)\n - target estimand: ATT\n - covariates: dem_age_index_cont, dem_sex_cont, c_smoking_history, c_number_met_sites, c_hemoglobin_g_dl_cont, c_urea_nitrogen_mg_dl_cont, c_platelets_10_9_l_cont, c_calcium_mg_dl_cont, c_glucose_mg_dl_cont, c_lymphocyte_leukocyte_ratio_cont, c_alp_u_l_cont, c_protein_g_l_cont, c_alt_u_l_cont, c_albumin_g_l_cont, c_bilirubin_mg_dl_cont, c_chloride_mmol_l_cont, c_monocytes_10_9_l_cont, c_eosinophils_leukocytes_ratio_cont, c_ldh_u_l_cont, c_hr_cont, c_sbp_cont, c_oxygen_cont, c_ecog_cont, c_neutrophil_lymphocyte_ratio_cont, c_bmi_cont, c_ast_alt_ratio_cont, c_stage_initial_dx_cont, dem_race, dem_region, dem_ses, c_time_dx_to_index\n\n\n\n\n4.5.4 Comparison of stacked datasets\nWe can now stack the datasets (= vertically append them) and compare the resulting 10 x 10 datasets for any differences:\n\n\nShow the code\nwaldo::compare(\n  MatchThem::complete(mimids_data_from_function), \n  MatchThem::complete(mimids_data)\n  )\n\n\n✔ No differences",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#session-info",
    "href": "chapters/re_weight.html#session-info",
    "title": "4  Re-weighting to a target population",
    "section": "4.6 Session info",
    "text": "4.6 Session info\nScript runtime: 0.45 minutes.\n\nLoaded packagesSession infoRepositories\n\n\n\n\nShow the code\npander::pander(subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)))\n\n\n\n\n\n\n\n\n\n\n \npackage\nloadedversion\n\n\n\n\ncardx\ncardx\n0.2.0\n\n\ndplyr\ndplyr\n1.1.4\n\n\ngtsummary\ngtsummary\n2.0.1\n\n\nhere\nhere\n1.0.1\n\n\nMatchIt\nMatchIt\n4.5.5\n\n\nMatchThem\nMatchThem\n1.2.1\n\n\nMatrix\nMatrix\n1.7-0\n\n\nmice\nmice\n3.16.0\n\n\nsmd\nsmd\n0.7.0\n\n\nsurvey\nsurvey\n4.4-2\n\n\nsurvival\nsurvival\n3.5-8\n\n\n\n\n\n\n\n\n\nShow the code\npander::pander(sessionInfo())\n\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nlocale: en_US.UTF-8||en_US.UTF-8||en_US.UTF-8||C||en_US.UTF-8||en_US.UTF-8\nattached base packages: grid, stats, graphics, grDevices, datasets, utils, methods and base\nother attached packages: smd(v.0.7.0), cardx(v.0.2.0), gtsummary(v.2.0.1), survey(v.4.4-2), Matrix(v.1.7-0), MatchIt(v.4.5.5), MatchThem(v.1.2.1), mice(v.3.16.0), survival(v.3.5-8), dplyr(v.1.1.4) and here(v.1.0.1)\nloaded via a namespace (and not attached): tidyselect(v.1.2.1), fastmap(v.1.2.0), digest(v.0.6.37), rpart(v.4.1.23), lifecycle(v.1.0.4), cluster(v.2.1.6), waldo(v.0.5.3), gdata(v.3.0.0), magrittr(v.2.0.3), compiler(v.4.4.0), sass(v.0.4.9), rlang(v.1.1.4), Hmisc(v.5.1-3), tools(v.4.4.0), gt(v.0.11.0), utf8(v.1.2.4), yaml(v.2.3.10), data.table(v.1.16.0), knitr(v.1.48), htmlwidgets(v.1.6.4), xml2(v.1.3.6), withr(v.3.0.1), foreign(v.0.8-86), purrr(v.1.0.2), nnet(v.7.3-19), fansi(v.1.0.6), jomo(v.2.7-6), colorspace(v.2.1-1), future(v.1.34.0), ggplot2(v.3.5.1), gtools(v.3.9.5), globals(v.0.16.3), scales(v.1.3.0), iterators(v.1.0.14), MASS(v.7.3-60.2), cli(v.3.6.3), rmarkdown(v.2.28), crayon(v.1.5.3), generics(v.0.1.3), rstudioapi(v.0.16.0), sessioninfo(v.1.2.2), commonmark(v.1.9.1), minqa(v.1.2.8), DBI(v.1.2.3), pander(v.0.6.5), stringr(v.1.5.1), splines(v.4.4.0), assertthat(v.0.2.1), parallel(v.4.4.0), base64enc(v.0.1-3), mitools(v.2.4), vctrs(v.0.6.5), WeightIt(v.1.3.0), boot(v.1.3-30), glmnet(v.4.1-8), jsonlite(v.1.8.8), mitml(v.0.4-5), Formula(v.1.2-5), htmlTable(v.2.4.3), listenv(v.0.9.1), weights(v.1.0.4), locfit(v.1.5-9.10), foreach(v.1.5.2), tidyr(v.1.3.1), glue(v.1.7.0), parallelly(v.1.38.0), nloptr(v.2.1.1), pan(v.1.9), chk(v.0.9.2), codetools(v.0.2-20), stringi(v.1.8.4), shape(v.1.4.6.1), gtable(v.0.3.5), lme4(v.1.1-35.5), munsell(v.0.5.1), tibble(v.3.2.1), anesrake(v.0.80), pillar(v.1.9.0), furrr(v.0.3.1), htmltools(v.0.5.8.1), R6(v.2.5.1), rprojroot(v.2.0.4), evaluate(v.0.24.0), lattice(v.0.22-6), markdown(v.1.13), cards(v.0.2.1), backports(v.1.5.0), tictoc(v.1.2.1), broom(v.1.0.6), renv(v.1.0.7), simsurv(v.1.0.0), Rcpp(v.1.0.13), checkmate(v.2.3.2), gridExtra(v.2.3), nlme(v.3.1-164), xfun(v.0.47) and pkgconfig(v.2.0.3)\n\n\n\n\n\n\nShow the code\npander::pander(options('repos'))\n\n\n\nrepos:\n\n\n\n\n\n\nREPO_NAME\n\n\n\n\nhttps://packagemanager.posit.co/cran/latest",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/re_weight.html#section",
    "href": "chapters/re_weight.html#section",
    "title": "4  Re-weighting to a target population",
    "section": "4.7 ",
    "text": "4.7",
    "crumbs": [
      "<span class='chapter-number'>4</span>  <span class='chapter-title'>Re-weighting to a target population</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html",
    "href": "chapters/subgroup_analysis.html",
    "title": "5  Subgroup analysis",
    "section": "",
    "text": "5.1 About\nThis script is adapted from Noah Greifer’s highly recommended blog post on “Subgroup Analysis After Propensity Score Matching Using R”.\nFor a more formal manuscript on subgroup analysis with propensity scores, see Green and Stuart.(Green and Stuart 2014)",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#data-generation",
    "href": "chapters/subgroup_analysis.html#data-generation",
    "title": "5  Subgroup analysis",
    "section": "5.2 Data generation",
    "text": "5.2 Data generation\nWe again use the simulate_flaura() function to simulate a realistic oncology comparative effectiveness cohort analytic dataset.\n\n# load example dataset with missing observations\ndata_miss &lt;- simulate_flaura(\n  n_total = 3500, \n  seed = 42, \n  include_id = FALSE, \n  imposeNA = TRUE,\n  propNA = .13\n  ) |&gt; \n  # convert dem_race into a binary Asian vs. non-Asian \n  mutate(dem_race = factor(ifelse(dem_race == \"Asian\", \"Asian\", \"Non-Asian\")))",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#moderator-covariate",
    "href": "chapters/subgroup_analysis.html#moderator-covariate",
    "title": "5  Subgroup analysis",
    "section": "5.3 Moderator covariate",
    "text": "5.3 Moderator covariate\nIn this example, we assume heterogeneous treatment effect by race and we aim to assess the average treatment effect among the treated for Asian (reference) and non-Asian patients. The effect size is time to all-cause mortality. In this dataset, race is encoded with a binary covariate with 0 = Asian and 1 = non-Asian.\n\ntable(data_miss$dem_race, useNA = \"ifany\")\n\n\n    Asian Non-Asian      &lt;NA&gt; \n     1091      1929       480 \n\n\n\n\n\nInvestigated subgroup effect in the FLAURA trial.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#multiple-imputation",
    "href": "chapters/subgroup_analysis.html#multiple-imputation",
    "title": "5  Subgroup analysis",
    "section": "5.4 Multiple imputation",
    "text": "5.4 Multiple imputation\nBoth the imputation and propensity score step Multiple imputation using mice:\n\n# impute data\ndata_imp &lt;- futuremice(\n  parallelseed = 42,\n  n.core = parallel::detectCores()-1,\n  data = data_miss,\n  method = \"rf\",\n  m = 10,\n  print = FALSE\n  )",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#propensity-score-matching-and-weighting",
    "href": "chapters/subgroup_analysis.html#propensity-score-matching-and-weighting",
    "title": "5  Subgroup analysis",
    "section": "5.5 Propensity score matching and weighting",
    "text": "5.5 Propensity score matching and weighting\nApply propensity score matching and weighting with replacement within in each imputed dataset.\n\n# apply propensity score matching on mids object\ncovariates_for_ps &lt;- setdiff(covariates_for_ps, \"dem_race\")\nps_form &lt;- as.formula(paste(\"treat ~\", paste(covariates_for_ps, collapse = \" + \")))\nps_form\n\ntreat ~ dem_age_index_cont + dem_sex_cont + c_smoking_history + \n    c_number_met_sites + c_hemoglobin_g_dl_cont + c_urea_nitrogen_mg_dl_cont + \n    c_platelets_10_9_l_cont + c_calcium_mg_dl_cont + c_glucose_mg_dl_cont + \n    c_lymphocyte_leukocyte_ratio_cont + c_alp_u_l_cont + c_protein_g_l_cont + \n    c_alt_u_l_cont + c_albumin_g_l_cont + c_bilirubin_mg_dl_cont + \n    c_chloride_mmol_l_cont + c_monocytes_10_9_l_cont + c_eosinophils_leukocytes_ratio_cont + \n    c_ldh_u_l_cont + c_hr_cont + c_sbp_cont + c_oxygen_cont + \n    c_ecog_cont + c_neutrophil_lymphocyte_ratio_cont + c_bmi_cont + \n    c_ast_alt_ratio_cont + c_stage_initial_dx_cont + dem_region + \n    dem_ses + c_time_dx_to_index\n\n\n\nMatchingWeighting\n\n\n\nmatch_within_strata &lt;- function(i, \n                                imputed_data = NULL, \n                                ps_formula = NULL, \n                                filter_expr = NULL\n                                ){\n  \n  stratum &lt;- mice::complete(imputed_data, i) |&gt; \n    dplyr::filter(eval(filter_expr))\n    \n  matched &lt;- MatchIt::matchit(\n    formula = ps_formula, \n    data = stratum,\n    method = \"nearest\",\n    caliper = 0.01,\n    ratio = 1,\n    replace = F\n    ) |&gt; \n    MatchIt::match.data()\n  \n  return(matched)\n  \n}\n\nasian_matched &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = match_within_strata, \n  imputed_data = data_imp,\n  ps_formula = ps_form,\n  filter_expr = expr(dem_race == \"Asian\")\n  )\n\nnon_asian_matched &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = match_within_strata, \n  imputed_data = data_imp,\n  ps_formula = ps_form,\n  filter_expr = expr(dem_race == \"Non-Asian\")\n  )\n\n# combine the mth imputed and matched datasets\ncombine_list &lt;- function(i, data_0 = NULL, data_1 = NULL){\n  \n  data_combined &lt;- rbind(data_0[[i]], data_1[[i]])\n  \n  return(data_combined)\n  \n}\n\nmatched_all &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = combine_list, \n  data_0 = non_asian_matched,\n  data_1 = asian_matched\n  )\n\n\n\n\nweight_within_strata &lt;- function(i, \n                                 imputed_data = NULL, \n                                 ps_formula = NULL,\n                                 filter_expr = NULL\n                                 ){\n  \n  stratum &lt;- mice::complete(imputed_data, i) |&gt; \n    dplyr::filter(eval(filter_expr))\n  \n  weighted &lt;- WeightIt::weightit(\n    formula = ps_formula, \n    data = stratum,\n    method = \"glm\",\n    estimand = \"ATT\"\n    )\n  \n  # trim extreme weights\n  weighted &lt;- trim(\n    x = weighted, \n    at = .95, \n    lower = TRUE\n    )\n  \n  weighted_data &lt;- mice::complete(imputed_data, i) |&gt; \n    dplyr::filter(eval(filter_expr)) |&gt; \n    mutate(weights = weighted$weights)\n  \n  return(weighted_data)\n  \n}\n\nasian_weighted &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = weight_within_strata, \n  imputed_data = data_imp,\n  ps_formula = ps_form,\n  filter_expr = expr(dem_race == \"Asian\")\n  )\n\nnon_asian_weighted &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = weight_within_strata, \n  imputed_data = data_imp,\n  ps_formula = ps_form,\n  filter_expr = expr(dem_race == \"Non-Asian\")\n  )\n\nweighted_all &lt;- lapply(\n  X = 1:data_imp$m, \n  FUN = combine_list, \n  data_0 = asian_weighted,\n  data_1 = non_asian_weighted\n  )",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#outcome-model-comparisons",
    "href": "chapters/subgroup_analysis.html#outcome-model-comparisons",
    "title": "5  Subgroup analysis",
    "section": "5.6 Outcome model comparisons",
    "text": "5.6 Outcome model comparisons\n\nMatchingWeighting\n\n\n\ncox_fit_matching &lt;- function(i){\n  \n  survival_fit &lt;- survival::coxph(\n    data = i,\n    formula = Surv(fu_itt_months, death_itt) ~ treat*dem_race, \n    weights = weights, \n    cluster = subclass,\n    robust = TRUE\n    )\n  \n}\n\n\nmatched_all |&gt; \n  lapply(FUN = cox_fit_matching) |&gt; \n  mice::pool() |&gt; \n  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  dplyr::select(term, estimate, std.error, conf.low, conf.high)\n\n                     term  estimate  std.error  conf.low conf.high\n1                   treat 0.9576968 0.07559136 0.8250123 1.1117205\n2       dem_raceNon-Asian 0.9889503 0.07236700 0.8567030 1.1416124\n3 treat:dem_raceNon-Asian 0.6036740 0.09859211 0.4966413 0.7337737\n\n\n\n\n\ncox_fit_weighting &lt;- function(i){\n  \n  survival_fit &lt;- survival::coxph(\n    data = i,\n    formula = Surv(fu_itt_months, death_itt) ~ treat*dem_race, \n    weights = weights, \n    robust = TRUE\n    )\n  \n}\n\n\nweighted_all |&gt; \n  lapply(FUN = cox_fit_weighting) |&gt; \n  mice::pool() |&gt; \n  broom::tidy(exponentiate = TRUE, conf.int = TRUE) |&gt; \n  dplyr::select(term, estimate, std.error, conf.low, conf.high)\n\n                     term  estimate  std.error  conf.low conf.high\n1                   treat 0.9540362 0.05859467 0.8504103 1.0702893\n2       dem_raceNon-Asian 0.9938111 0.06086045 0.8815299 1.1203936\n3 treat:dem_raceNon-Asian 0.6184604 0.07508937 0.5337307 0.7166409",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#references",
    "href": "chapters/subgroup_analysis.html#references",
    "title": "5  Subgroup analysis",
    "section": "5.7 References",
    "text": "5.7 References\n\n\nGreen, Kerry M., and Elizabeth A. Stuart. 2014. “Examining Moderation Analyses in Propensity Score Methods: Application to Depression and Substance Use.” Journal of Consulting and Clinical Psychology 82 (5): 773–83. https://doi.org/10.1037/a0036515.",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  },
  {
    "objectID": "chapters/subgroup_analysis.html#session-info",
    "href": "chapters/subgroup_analysis.html#session-info",
    "title": "5  Subgroup analysis",
    "section": "5.8 Session info",
    "text": "5.8 Session info\nScript runtime: 0.30 minutes.\n\nLoaded packagesSession infoRepositories\n\n\n\npander::pander(subset(data.frame(sessioninfo::package_info()), attached==TRUE, c(package, loadedversion)))\n\n\n\n\n\n\n\n\n\n \npackage\nloadedversion\n\n\n\n\ndplyr\ndplyr\n1.1.4\n\n\nfurrr\nfurrr\n0.3.1\n\n\nfuture\nfuture\n1.34.0\n\n\ngtsummary\ngtsummary\n2.0.1\n\n\nhere\nhere\n1.0.1\n\n\nMatchThem\nMatchThem\n1.2.1\n\n\nMatrix\nMatrix\n1.7-0\n\n\nmice\nmice\n3.16.0\n\n\nparallelly\nparallelly\n1.38.0\n\n\nranger\nranger\n0.16.0\n\n\nsurvey\nsurvey\n4.4-2\n\n\nsurvival\nsurvival\n3.5-8\n\n\n\n\n\n\n\n\npander::pander(sessionInfo())\n\nR version 4.4.0 (2024-04-24)\nPlatform: aarch64-apple-darwin20\nlocale: en_US.UTF-8||en_US.UTF-8||en_US.UTF-8||C||en_US.UTF-8||en_US.UTF-8\nattached base packages: grid, stats, graphics, grDevices, datasets, utils, methods and base\nother attached packages: furrr(v.0.3.1), future(v.1.34.0), ranger(v.0.16.0), parallelly(v.1.38.0), gtsummary(v.2.0.1), here(v.1.0.1), survey(v.4.4-2), Matrix(v.1.7-0), MatchThem(v.1.2.1), mice(v.3.16.0), survival(v.3.5-8) and dplyr(v.1.1.4)\nloaded via a namespace (and not attached): gtable(v.0.3.5), shape(v.1.4.6.1), xfun(v.0.47), ggplot2(v.3.5.1), htmlwidgets(v.1.6.4), MatchIt(v.4.5.5), lattice(v.0.22-6), simsurv(v.1.0.0), vctrs(v.0.6.5), tools(v.4.4.0), generics(v.0.1.3), parallel(v.4.4.0), tibble(v.3.2.1), fansi(v.1.0.6), pan(v.1.9), pkgconfig(v.2.0.3), jomo(v.2.7-6), assertthat(v.0.2.1), lifecycle(v.1.0.4), stringr(v.1.5.1), compiler(v.4.4.0), tictoc(v.1.2.1), munsell(v.0.5.1), mitools(v.2.4), codetools(v.0.2-20), htmltools(v.0.5.8.1), yaml(v.2.3.10), glmnet(v.4.1-8), pillar(v.1.9.0), nloptr(v.2.1.1), crayon(v.1.5.3), tidyr(v.1.3.1), MASS(v.7.3-60.2), sessioninfo(v.1.2.2), iterators(v.1.0.14), rpart(v.4.1.23), boot(v.1.3-30), foreach(v.1.5.2), mitml(v.0.4-5), nlme(v.3.1-164), locfit(v.1.5-9.10), WeightIt(v.1.3.0), tidyselect(v.1.2.1), digest(v.0.6.37), stringi(v.1.8.4), pander(v.0.6.5), listenv(v.0.9.1), purrr(v.1.0.2), splines(v.4.4.0), rprojroot(v.2.0.4), fastmap(v.1.2.0), colorspace(v.2.1-1), cli(v.3.6.3), magrittr(v.2.0.3), utf8(v.1.2.4), broom(v.1.0.6), withr(v.3.0.1), scales(v.1.3.0), backports(v.1.5.0), rmarkdown(v.2.28), globals(v.0.16.3), nnet(v.7.3-19), lme4(v.1.1-35.5), chk(v.0.9.2), evaluate(v.0.24.0), knitr(v.1.48), rlang(v.1.1.4), Rcpp(v.1.0.13), glue(v.1.7.0), DBI(v.1.2.3), renv(v.1.0.7), rstudioapi(v.0.16.0), minqa(v.1.2.8), jsonlite(v.1.8.8) and R6(v.2.5.1)\n\n\n\n\n\npander::pander(options('repos'))\n\n\nrepos:\n\n\n\n\n\n\nREPO_NAME\n\n\n\n\nhttps://packagemanager.posit.co/cran/latest",
    "crumbs": [
      "<span class='chapter-number'>5</span>  <span class='chapter-title'>Subgroup analysis</span>"
    ]
  }
]